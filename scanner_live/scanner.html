<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner QR — Dezembro Vermelho</title>
  <link rel="icon" href="favicon.png" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .logout-btn {
      background: #b50000;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.3s;
    }
    .logout-btn:hover { background: #800000; }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      color: #d49b00;
    }
    .modal-body {
      background: #fffbe6;
      border: 2px solid #d49b00;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <div class="card">
      <div class="header">
        <img src="assets/logo.png" class="header-logo" alt="Logo" />
        <h1>Scanner de Check-in</h1>
        <p class="subtitle" id="userInfo"></p>
      </div>

      <div class="scanner-container">
        <div id="reader" class="scanner-box"></div>
        <div id="status" class="scanner-status">Inicializando câmera...</div>
      </div>

      <div class="manual-entry">
        <h3>Inserir manualmente</h3>
        <input type="text" id="manualTicket" placeholder="Digite o código (ex: DV25-ABC1234)" />
        <button id="manualSubmit" class="primary">Enviar</button>
      </div>

      <button id="logoutBtn" class="logout-btn">Sair</button>
    </div>
  </div>

  <!-- Duplicate Modal -->
  <div id="duplicateModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <span style="font-size: 32px;">⚠️</span>
        <h2>Check-in Já Realizado</h2>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button id="modalCloseBtn" class="modal-close-btn">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header" style="color: green;">
        <span style="font-size: 32px;">✅</span>
        <h2>Check-in Confirmado!</h2>
      </div>
      <div class="modal-body" id="successModalBody" style="background: #e8f5e9;"></div>
      <div class="modal-footer">
        <button id="successModalCloseBtn" class="modal-close-btn" style="background: green;">Fechar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const auth = urlParams.get("auth");
      const staffName = decodeURIComponent(urlParams.get("staffName") || "");
      const statusEl = document.getElementById("status");
      const userInfo = document.getElementById("userInfo");
      const logoutBtn = document.getElementById("logoutBtn");
      const webhookUrl = "https://n8n.bebot.co/webhook/checkin-dv-2025";

      userInfo.textContent = staffName
        ? `Olá, ${staffName}!`
        : "Usuário não identificado.";

      // -------------------------------
      // STRICT REAR CAMERA IMPLEMENTATION
      // -------------------------------
      async function forceRearCameraId() {
        // Try EXACT environment
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } },
            audio: false
          });
          const track = stream.getVideoTracks()[0];
          const id = track.getSettings().deviceId;
          stream.getTracks().forEach(t => t.stop());
          if (id) return id;
        } catch (e) {}

        // Try soft environment
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false
          });
          const track = stream.getVideoTracks()[0];
          const id = track.getSettings().deviceId;
          stream.getTracks().forEach(t => t.stop());
          if (id) return id;
        } catch (e) {}

        // Enumerate devices (iOS labels empty → rear is last)
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videos = devices.filter(d => d.kind === "videoinput");
          if (videos.length === 0) return null;
          return videos[videos.length - 1].deviceId;
        } catch (e) {
          return null;
        }
      }

      const html5QrCode = new Html5Qrcode("reader");
      const qrConfig = { fps: 10, qrbox: 250 };
      let cameraId = null;
      let isScanning = false;

      const onScanSuccess = async (decodedText) => {
        if (isScanning) return;
        isScanning = true;
        await html5QrCode.stop().catch(()=>{});
        statusEl.textContent = "QR Code detectado. Validando...";
        const cleanId = decodedText.split("id=")[1] || decodedText.trim();
        await sendCheckin(cleanId);
      };

      // --------------------
      // START STRICT REAR CAMERA
      // --------------------
      try {
        statusEl.textContent = "Selecionando câmera traseira...";
        const forcedId = await forceRearCameraId();

        if (!forcedId) {
          statusEl.textContent = "❌ A câmera traseira não pôde ser acessada.";
          return;
        }

        cameraId = forcedId;
        await html5QrCode.start(cameraId, qrConfig, onScanSuccess);
        statusEl.textContent = "Câmera traseira ativa. Aponte para o QR Code.";

      } catch (err) {
        console.error("Erro ao iniciar câmera traseira:", err);
        statusEl.textContent = "❌ Falha ao iniciar a câmera traseira.";
      }

      async function restartCamera() {
        isScanning = false;
        if (!cameraId) return;
        try {
          await html5QrCode.start(cameraId, qrConfig, onScanSuccess);
        } catch (e) {}
      }

      async function sendCheckin(ticketId) {
        try {
          statusEl.textContent = "Verificando ingresso...";
          const resp = await fetch(
            `${webhookUrl}?id=${encodeURIComponent(ticketId)}&auth=${encodeURIComponent(auth)}&staffName=${encodeURIComponent(staffName)}`
          );
          let result;
          const type = resp.headers.get("content-type");

          if (type.includes("application/json")) {
            result = await resp.json();
          } else {
            statusEl.textContent = "⚠️ Workflow antigo ativo";
            return;
          }

          let data = result?.json || result;

          if (data.alreadyChecked) {
            showDuplicateModal(data);
            statusEl.textContent = "⚠️ Check-in já realizado.";
            return;
          }

          if (data.success || data.checked_in) {
            showSuccessModal(data);
            statusEl.textContent = "✅ Check-in confirmado.";
            return;
          }

          statusEl.textContent = "❌ Erro ao validar ingresso.";
          setTimeout(() => restartCamera(), 2000);

        } catch (err) {
          statusEl.textContent = "❌ Erro de conexão.";
        }
      }

      // MANUAL ENTRY
      document.getElementById("manualSubmit")
        .addEventListener("click", async () => {
          const t = document.getElementById("manualTicket").value.trim();
          if (!t) return alert("Digite um código válido.");
          await sendCheckin(t);
        });

      // LOGOUT
      logoutBtn.addEventListener("click", () => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "login.html";
      });

      // --------------------
      // MODAL FUNCTIONS
      // --------------------
      function showDuplicateModal(data) {
        document.getElementById("modalBody").innerHTML = `
          <p><strong>Participante:</strong> ${data.nome_completo}</p>
          <p><strong>Atividade:</strong> ${data.atividade_nome}</p>
          <p><strong>Ticket:</strong> ${data.ticket_id}</p>
        `;
        document.getElementById("duplicateModal").classList.add("active");
      }
      document.getElementById("modalCloseBtn").onclick = () => {
        document.getElementById("duplicateModal").classList.remove("active");
        restartCamera();
      };

      function showSuccessModal(data) {
        document.getElementById("successModalBody").innerHTML = `
          <p><strong>Participante:</strong> ${data.nome_completo}</p>
          <p><strong>Atividade:</strong> ${data.atividade_nome}</p>
          <p><strong>Ticket:</strong> ${data.ticket_id}</p>
        `;
        document.getElementById("successModal").classList.add("active");
      }
      document.getElementById("successModalCloseBtn").onclick = () => {
        document.getElementById("successModal").classList.remove("active");
        restartCamera();
      };
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner QR ‚Äî Dezembro Vermelho</title>
  <link rel="icon" href="favicon.png" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .logout-btn {
      background: #b50000;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.3s;
    }
    .logout-btn:hover { background: #800000; }

    /* Modal for duplicate check-in alert */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      color: #d49b00;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 22px;
    }
    .modal-body {
      background: #fffbe6;
      border: 2px solid #d49b00;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .modal-body p {
      margin: 8px 0;
      font-size: 16px;
      line-height: 1.5;
    }
    .modal-body strong {
      color: #333;
    }
    .modal-footer {
      text-align: center;
    }
    .modal-close-btn {
      background: #d49b00;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .modal-close-btn:hover {
      background: #b88400;
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <div class="card">
      <div class="header">
        <img src="assets/logo.png" class="header-logo" alt="Logo" />
        <h1>Scanner de Check-in</h1>
        <p class="subtitle" id="userInfo"></p>
      </div>

      <div class="scanner-container">
        <div id="reader" class="scanner-box"></div>
        <div id="status" class="scanner-status">Inicializando c√¢mera...</div>
      </div>

      <div class="manual-entry">
        <h3>Inserir manualmente</h3>
        <input type="text" id="manualTicket" placeholder="Digite o c√≥digo (ex: DV25-ABC1234)" />
        <button id="manualSubmit" class="primary">Enviar</button>
      </div>

      <button id="logoutBtn" class="logout-btn">Sair</button>
    </div>
  </div>

  <!-- Modal for duplicate check-in alert -->
  <div id="duplicateModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <span style="font-size: 32px;">‚ö†Ô∏è</span>
        <h2>Check-in J√° Realizado</h2>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamic content will be inserted here -->
      </div>
      <div class="modal-footer">
        <button id="modalCloseBtn" class="modal-close-btn">Fechar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const auth = urlParams.get("auth");
      const staffName = decodeURIComponent(urlParams.get("staffName") || "");
      const statusEl = document.getElementById("status");
      const userInfo = document.getElementById("userInfo");
      const logoutBtn = document.getElementById("logoutBtn");
      const webhookUrl = "https://n8n.bebot.co/webhook/checkin-dv-2025";

      // üîä Preload sounds to allow playback on iOS/Android
      const beepSuccess = new Audio("assets/success.mp3");
      const beepError = new Audio("assets/error.mp3");

      // Set properties to help with mobile autoplay
      beepSuccess.preload = "auto";
      beepError.preload = "auto";
      beepSuccess.volume = 1.0;
      beepError.volume = 1.0;

      // Load sounds
      [beepSuccess, beepError].forEach(audio => audio.load());

      // Enable audio on first user interaction (required for mobile)
      let audioUnlocked = false;
      const unlockAudio = () => {
        if (!audioUnlocked) {
          beepSuccess.play().then(() => beepSuccess.pause()).catch(() => {});
          beepError.play().then(() => beepError.pause()).catch(() => {});
          audioUnlocked = true;
          console.log("Audio unlocked");
          document.removeEventListener("click", unlockAudio);
          document.removeEventListener("touchstart", unlockAudio);
        }
      };
      document.addEventListener("click", unlockAudio);
      document.addEventListener("touchstart", unlockAudio);

      // Modal elements
      const duplicateModal = document.getElementById("duplicateModal");
      const modalBody = document.getElementById("modalBody");
      const modalCloseBtn = document.getElementById("modalCloseBtn");

      // Display logged-in staff name
      userInfo.textContent = staffName
        ? `Ol√°, ${staffName}!`
        : "Usu√°rio n√£o identificado.";

      // Logout handler
      logoutBtn.addEventListener("click", () => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "login.html";
      });

      // Modal close handler
      modalCloseBtn.addEventListener("click", () => {
        duplicateModal.classList.remove("active");
      });

      // Close modal on overlay click
      duplicateModal.addEventListener("click", (e) => {
        if (e.target === duplicateModal) {
          duplicateModal.classList.remove("active");
        }
      });

      // Function to show duplicate check-in modal
      const showDuplicateModal = (data) => {
        const html = `
          <p><strong>Participante:</strong> ${data.nome_completo || 'N/A'}</p>
          <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
          <p><strong>Atividade:</strong> ${data.atividade_nome || 'N/A'}</p>
          <p><strong>Ticket ID:</strong> ${data.ticket_id || 'N/A'}</p>
          <p><strong>Check-in realizado em:</strong> ${data.checkin_timestamp || 'N/A'}</p>
          <p><strong>Verificado por:</strong> ${data.checked_by || 'N/A'}</p>
        `;
        modalBody.innerHTML = html;
        duplicateModal.classList.add("active");
        beepError.play().catch(()=>{});
      };

      // Function to send the check-in request
      const sendCheckin = async (ticketId) => {
        try {
          statusEl.textContent = "Verificando ingresso...";
          statusEl.style.color = "#000";
          const resp = await fetch(
            `${webhookUrl}?id=${encodeURIComponent(ticketId)}&auth=${encodeURIComponent(auth)}&staffName=${encodeURIComponent(staffName)}`
          );

          // Check if response is JSON or HTML
          const contentType = resp.headers.get("content-type");
          let result;

          if (contentType && contentType.includes("application/json")) {
            result = await resp.json();
            console.log("Resposta JSON:", result);
          } else {
            // HTML response means old workflow is active
            const html = await resp.text();
            console.warn("Resposta HTML (workflow antigo ativo):", html);
            statusEl.textContent = "‚ö†Ô∏è Workflow antigo ativo. Por favor, ative v2.2 no N8N.";
            statusEl.style.color = "orange";
            beepError.play().catch(()=>{});
            return;
          }

          // Log full response for debugging
          console.log("Full response object:", JSON.stringify(result, null, 2));

          if (result.alreadyChecked === true) {
            statusEl.textContent = result.message || "‚ö†Ô∏è J√° realizou check-in.";
            statusEl.style.color = "#d49b00";
            showDuplicateModal(result);
            setTimeout(() => restartCamera(), 2000);
          } else if (result.success === true || result.checked_in === true) {
            statusEl.textContent = "‚úÖ Check-in registrado com sucesso!";
            statusEl.style.color = "green";
            beepSuccess.play().catch((e) => console.log("Sound error:", e));
            setTimeout(() => {
              statusEl.textContent = "C√¢mera ativa. Aponte para o pr√≥ximo QR Code.";
              statusEl.style.color = "#000";
              restartCamera();
            }, 3000);
          } else if (result.error === true) {
            statusEl.textContent = result.message || "‚ùå Erro ao processar check-in.";
            statusEl.style.color = "red";
            beepError.play().catch((e) => console.log("Sound error:", e));
            setTimeout(() => restartCamera(), 2000);
          } else {
            // Unknown response format - log everything
            console.error("Formato de resposta desconhecido:", result);
            console.error("Keys in response:", Object.keys(result));
            console.error("Values:", Object.values(result));
            statusEl.textContent = "‚ùå Resposta inesperada. Veja console (F12).";
            statusEl.style.color = "red";
            beepError.play().catch((e) => console.log("Sound error:", e));
            setTimeout(() => restartCamera(), 2000);
          }
        } catch (err) {
          console.error("Erro:", err);
          statusEl.textContent = "Erro de conex√£o com o servidor.";
          statusEl.style.color = "red";
          beepError.play().catch((e) => console.log("Sound error:", e));
        }
      };

      // Manual entry fallback
      document.getElementById("manualSubmit").addEventListener("click", async () => {
        const ticket = document.getElementById("manualTicket").value.trim();
        if (!ticket) {
          alert("Digite um c√≥digo de ingresso v√°lido (ex: DV25-XXXXXXX)");
          return;
        }
        await sendCheckin(ticket);
      });

      // Initialize camera
      if (typeof Html5Qrcode === "undefined") {
        statusEl.textContent = "Erro: biblioteca html5-qrcode n√£o encontrada.";
        return;
      }

      const html5QrCode = new Html5Qrcode("reader");
      const qrConfig = { fps: 10, qrbox: 250 };
      let cameraId = null;
      let isScanning = false;

      const onScanSuccess = async (decodedText) => {
        if (isScanning) return; // Prevent multiple scans
        isScanning = true;

        console.log("QR detectado:", decodedText);
        html5QrCode.stop().catch(() => {});
        statusEl.textContent = "QR Code detectado. Validando...";
        await sendCheckin(decodedText.split("id=")[1] || decodedText.trim());
      };

      // Function to restart camera
      const restartCamera = async () => {
        try {
          isScanning = false;
          if (cameraId) {
            await html5QrCode.start(cameraId, qrConfig, onScanSuccess);
            console.log("Camera restarted");
          }
        } catch (err) {
          console.error("Erro ao reiniciar c√¢mera:", err);
        }
      };

      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          const backCamera = devices.find((d) =>
            d.label.toLowerCase().includes("back") ||
            d.label.toLowerCase().includes("rear") ||
            d.label.toLowerCase().includes("environment")
          );
          cameraId = backCamera ? backCamera.id : devices[0].id;
          await html5QrCode.start(cameraId, qrConfig, onScanSuccess);
          statusEl.textContent = "C√¢mera ativa. Aponte para o QR Code do ingresso.";
        } else {
          statusEl.textContent = "Nenhuma c√¢mera encontrada. Use o campo manual.";
        }
      } catch (err) {
        console.error("Falha ao acessar c√¢mera:", err);
        statusEl.textContent = "Falha ao acessar a c√¢mera. Use o campo manual.";
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dezembro Vermelho 2025 - Programa√ß√£o e Inscri√ß√µes</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #a61a32 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-section h3 {
            margin-bottom: 15px;
            color: #c41e3a;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #c41e3a;
            background: white;
            color: #c41e3a;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: #c41e3a;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(196, 30, 58, 0.2);
        }

        .filter-btn.active {
            background: #c41e3a;
            color: white;
            box-shadow: 0 2px 6px rgba(196, 30, 58, 0.3);
        }

        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .activity-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 4px solid #c41e3a;
        }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(196, 30, 58, 0.2);
        }

        .activity-card h3 {
            color: #c41e3a;
            margin-bottom: 12px;
            font-size: 1.1em;
            min-height: 2.4em;
        }

        .activity-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 0.9em;
            color: #666;
        }

        .activity-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity-meta-item strong {
            min-width: 80px;
            color: #333;
        }

        .activity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
        }

        .capacity-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 16px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
            text-align: center;
        }

        .capacity-full {
            background: #ffebee;
            color: #c62828;
        }

        .register-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: #c41e3a;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .register-btn:hover {
            background: #a61a32;
        }

        .register-btn.disabled {
            background: #ccc;
            cursor: not-allowed;
            pointer-events: none;
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .activities-grid {
                grid-template-columns: 1fr;
            }

            .filter-btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .filter-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üéó Dezembro Vermelho 2025</h1>
        <p>40 anos da resposta brasileira √† AIDS</p>
    </div>

    <div class="container">
        <div class="filter-section">
            <h3>üìÖ Selecione o dia</h3>
            <div class="filter-buttons" id="dayButtons">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div class="filter-section">
            <h3>üé≠ Filtrar por tipo de evento</h3>
            <div class="filter-buttons" id="typeButtons">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div id="loading" class="loading">
            Carregando atividades...
        </div>

        <div class="activities-grid" id="activitiesGrid" style="display: none;">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <div class="footer">
        ¬© 2025 Minist√©rio da Sa√∫de ‚Äì Programa Dezembro Vermelho<br />
        40 anos da resposta brasileira √† AIDS
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            // Live data from n8n webhook (real-time availability from Google Sheets)
            activitiesDataURL: "https://n8n.bebot.co/webhook/activities-json",
            // Use dynamic form (form-template.html with ?id=X parameter)
            // OR use static forms (forms/form-1.html, forms/form-2.html, etc.)
            formType: "dynamic", // Options: "dynamic" or "static"
            dynamicFormPath: "./form-template.html",
            staticFormPath: "./forms/form-{id}.html"
        };

        // ============================================
        // STATE
        // ============================================
        let allActivities = [];
        let currentDayFilter = "all";
        let currentTypeFilter = "all";

        // ============================================
        // UTILITIES
        // ============================================

        function getFormURL(activityId) {
            if (CONFIG.formType === "dynamic") {
                return `${CONFIG.dynamicFormPath}?id=${activityId}`;
            } else {
                return CONFIG.staticFormPath.replace("{id}", activityId);
            }
        }

        function getUniqueTypes(activities) {
            const types = activities.map(a => a.tipo);
            return [...new Set(types)].sort();
        }

        function getUniqueDates(activities) {
            const dates = activities.map(a => a.data);
            const uniqueDates = [...new Set(dates)];

            // Sort dates chronologically
            return uniqueDates.sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/');
                const [dayB, monthB, yearB] = b.split('/');
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });
        }

        function formatDateLabel(dateStr) {
            // Convert "01/12/2025" to "1 de Dezembro"
            const [day, month, year] = dateStr.split('/');
            const date = new Date(year, month - 1, day);

            const months = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            const dayName = days[date.getDay()];
            const monthName = months[date.getMonth()];

            return `${parseInt(day)} de ${monthName} (${dayName})`;
        }

        function filterActivities(activities, dateFilter, typeFilter) {
            let filtered = activities;

            // Filter by date
            if (dateFilter !== "all") {
                filtered = filtered.filter(a => a.data === dateFilter);
            }

            // Filter by type
            if (typeFilter !== "all") {
                filtered = filtered.filter(a => a.tipo === typeFilter);
            }

            return filtered;
        }

        function getTypesForCurrentDay() {
            // Get activities for currently selected day
            let dayActivities = allActivities;
            if (currentDayFilter !== "all") {
                dayActivities = allActivities.filter(a => a.data === currentDayFilter);
            }

            // Get unique types from those activities
            const types = dayActivities.map(a => a.tipo);
            return [...new Set(types)].sort();
        }

        // ============================================
        // RENDERING
        // ============================================

        function renderDayButtons(activities) {
            const dates = getUniqueDates(activities);
            const container = document.getElementById("dayButtons");
            container.innerHTML = ''; // Clear existing buttons

            // Add "All Days" button
            const allBtn = document.createElement("button");
            allBtn.className = "filter-btn" + (currentDayFilter === "all" ? " active" : "");
            allBtn.textContent = "Todos os Dias";
            allBtn.onclick = () => setDayFilter("all");
            container.appendChild(allBtn);

            // Add date buttons
            dates.forEach(date => {
                const btn = document.createElement("button");
                btn.className = "filter-btn" + (currentDayFilter === date ? " active" : "");
                btn.textContent = formatDateLabel(date);
                btn.dataset.date = date; // Store original date for filtering
                btn.onclick = () => setDayFilter(date);
                container.appendChild(btn);
            });
        }

        function renderTypeButtons() {
            const types = getTypesForCurrentDay();
            const container = document.getElementById("typeButtons");
            container.innerHTML = ''; // Clear existing buttons

            // Add "All Types" button
            const allBtn = document.createElement("button");
            allBtn.className = "filter-btn" + (currentTypeFilter === "all" ? " active" : "");
            allBtn.textContent = "Todos os Tipos";
            allBtn.onclick = () => setTypeFilter("all");
            container.appendChild(allBtn);

            // Add type buttons
            types.forEach(type => {
                const btn = document.createElement("button");
                btn.className = "filter-btn" + (currentTypeFilter === type ? " active" : "");
                btn.textContent = type;
                btn.onclick = () => setTypeFilter(type);
                container.appendChild(btn);
            });
        }

        function renderActivities(activities) {
            const grid = document.getElementById("activitiesGrid");
            grid.innerHTML = "";

            const filtered = filterActivities(activities, currentDayFilter, currentTypeFilter);

            if (filtered.length === 0) {
                grid.innerHTML = "<p style='text-align:center;color:#666;padding:40px;'>Nenhuma atividade encontrada para este dia/tipo.</p>";
                return;
            }

            filtered.forEach(activity => {
                const card = document.createElement("div");
                card.className = "activity-card";

                const hasVagas = activity.vagas_disponiveis > 0;

                card.innerHTML = `
                    <h3>${activity.nome_atividade}</h3>

                    <div class="activity-meta">
                        <div class="activity-meta-item">
                            <strong>üìÖ Data:</strong>
                            <span>${activity.data}</span>
                        </div>
                        <div class="activity-meta-item">
                            <strong>üïí Hor√°rio:</strong>
                            <span>${activity.horario}</span>
                        </div>
                        <div class="activity-meta-item">
                            <strong>üìç Local:</strong>
                            <span>${activity.local}</span>
                        </div>
                        <div class="activity-meta-item">
                            <strong>üé≠ Tipo:</strong>
                            <span class="activity-badge">${activity.tipo}</span>
                        </div>
                    </div>

                    <div class="capacity-info ${!hasVagas ? 'capacity-full' : ''}">
                        ${hasVagas
                            ? `‚úÖ ${activity.vagas_disponiveis} de ${activity.capacidade} vagas dispon√≠veis`
                            : `‚ùå Inscri√ß√µes encerradas (${activity.capacidade}/${activity.capacidade})`
                        }
                    </div>

                    <a href="${getFormURL(activity.id)}"
                       class="register-btn ${!hasVagas ? 'disabled' : ''}">
                        ${hasVagas ? 'Fazer Inscri√ß√£o' : 'Vagas Esgotadas'}
                    </a>
                `;

                grid.appendChild(card);
            });
        }

        function setDayFilter(dateFilter) {
            currentDayFilter = dateFilter;
            currentTypeFilter = "all"; // Reset type filter when day changes

            // Re-render type buttons based on new day
            renderTypeButtons();

            // Re-render day buttons to update active state
            renderDayButtons(allActivities);

            // Re-render activities
            renderActivities(allActivities);
        }

        function setTypeFilter(typeFilter) {
            currentTypeFilter = typeFilter;

            // Re-render type buttons to update active state
            renderTypeButtons();

            // Re-render activities
            renderActivities(allActivities);
        }

        // ============================================
        // MAIN
        // ============================================

        async function init() {
            try {
                const response = await fetch(CONFIG.activitiesDataURL);
                if (!response.ok) {
                    throw new Error("N√£o foi poss√≠vel carregar os dados das atividades.");
                }

                const data = await response.json();

                // Handle both formats: plain array or wrapped in {activities: [...]}
                allActivities = Array.isArray(data) ? data : data.activities;

                // Hide loading, show grid
                document.getElementById("loading").style.display = "none";
                document.getElementById("activitiesGrid").style.display = "grid";

                // Render components
                renderDayButtons(allActivities);
                renderTypeButtons();
                renderActivities(allActivities);

            } catch (error) {
                console.error("Error loading activities:", error);
                document.getElementById("loading").innerHTML = `
                    <p style="color: #c62828;">
                        ‚ùå Erro ao carregar atividades: ${error.message}
                    </p>
                `;
            }
        }

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", init);
    </script>

</body>
</html>
